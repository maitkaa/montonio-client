name: Publish

on:
    push:
        branches:
            - master

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
            -   name: Checkout code
                uses: actions/checkout@v2

            -   name: Set up Node.js
                uses: actions/setup-node@v2
                with:
                    node-version: '18'
                    registry-url: 'https://registry.npmjs.org'

            -   name: Install dependencies
                run: npm ci

            -   name: Run tests
                run: npm test

            -   name: Build package
                run: npm run build

            -   name: Bump version and push tag
                run: |
                    git config --local user.email "maitkaa@users.noreply.github.com"
                    git config --local user.name "maitkaa"
                    npm version patch -m "Bump to %s"
                    git push origin --tags

            -   name: Publish
                run: npm publish
                env:
                    NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

            -   name: Create Release
                id: create_release
                uses: actions/create-release@v1
                env:
                    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                with:
                    tag_name: ${{ github.ref }}
                    release_name: Release ${{ github.ref }}
                    draft: false
                    prerelease: false
