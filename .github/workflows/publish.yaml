name: Main Workflow

on:
    push:
        branches:
            - master

jobs:
    build-and-publish:
        runs-on: ubuntu-latest

        steps:
            -   name: Checkout code
                uses: actions/checkout@v4

            -   name: Set up Node.js
                uses: actions/setup-node@v3
                with:
                    node-version: '20'

            -   name: Install dependencies
                run: npm ci

            -   name: Run tests
                run: npm test

            -   name: Build package
                run: npm run build

            -   name: Create GitHub Release
                id: create_release
                uses: actions/create-release@v1
                env:
                    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                with:
                    tag_name: ${{ github.ref }}
                    release_name: Release ${{ github.ref }}
                    draft: false
                    prerelease: false

            -   name: Publish to npm
                if: success() && github.event_name == 'push' && github.ref == 'refs/heads/master'
                uses: JS-DevTools/npm-publish@v3
                with:
                    token: ${{ secrets.NPM_TOKEN }}
